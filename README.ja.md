# Health Recovery Tracker

> ワークアウトスクリーンショットから筋肉レベルの回復状態を追跡し、説明可能な推奨を提供

**ステータス**: v1.0 (製造完了)  
**プラットフォーム**: Web (Mobile Safari 実機検証済み)

---

## 課題

多くのフィットネスアプリは「何をしたか」を記録しますが、以下の問いには答えられません：
- 今日どの筋肉がトレーニング可能な状態か？
- 各筋肉群の回復状況はどうか？

複数の運動種目（ウェイト、有酸素）を統一された筋肉単位の疲労モデルに統合することは容易ではありません。既存ツールは全身疲労として過度に単純化するか、煩雑な手動入力を要求します。

## 解決策

本プロジェクトは、ワークアウトスクリーンショット（例：Fleekアプリのエクスポート）を構造化データに変換し、時間減衰モデルを用いて筋肉ごとの回復状態を計算します。結果は説明可能な形式で提供され、各筋肉に対する主要な貢献エクササイズと回復状況を表示します。

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                         iPhone Safari                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FastAPI (0.0.0.0:8000)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │
│  │ /uploads │  │/sessions │  │/recovery │  │ /exercises/alias │ │
│  └────┬─────┘  └──────────┘  └────┬─────┘  └──────────────────┘ │
└───────┼───────────────────────────┼─────────────────────────────┘
        │                           │
        ▼                           │
┌───────────────┐                   │
│  Redis Queue  │                   │
└───────┬───────┘                   │
        │                           │
        ▼                           │
┌───────────────┐                   │
│   RQ Worker   │                   │
│  ┌─────────┐  │                   │
│  │ Parser  │  │                   │
│  └────┬────┘  │                   │
└───────┼───────┘                   │
        │                           │
        ▼                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                         PostgreSQL                               │
│  uploads │ sessions │ exercises │ sets │ exercise_aliases       │
└─────────────────────────────────────────────────────────────────┘
```

**設計意図**:
- **Upload API → Queue**: クライアントへ即座に応答を返し、処理は非同期で実行
- **Worker**: パース失敗をAPI可用性から分離し、システム全体の安定性を確保
- **Parserモジュール**: 交換可能な設計により、将来的に他のOCR形式にも対応可能
- **Recovery計算**: オンデマンド計算により、常に最新データを反映（キャッシュの陳腐化を回避）

---

## 技術スタック

| レイヤー | 技術 | 選定理由 |
|---------|------|----------|
| API | FastAPI | 自動ドキュメント生成、型ヒント、非同期対応 |
| ORM | SQLAlchemy 2.0 | 明示的なクエリ記述、将来の拡張性 |
| DB | PostgreSQL | リレーショナル整合性、JSON型サポート |
| Queue | Redis + RQ | ローカル開発における最小オーバーヘッド |
| Frontend | Vue 3 + TypeScript | リアクティブUI、モバイルフレンドリー |
| Infra | Docker Compose | ゼロコストのローカルファースト開発 |

---

## 主要な設計判断

### 1. セッションスコープのエクササイズモデル

エクササイズはグローバルマスターテーブルに格納せず、**各セッションに帰属**させています。

**なぜこの設計が妥当か？**

| 検討事項 | 分析 |
|---------|------|
| 入力データの品質 | ユーザー入力は表記揺れが多い（"Bench Press" vs "벤치프레스" vs "ベンチプレス"） |
| グローバル正規化のコスト | MVP段階では保守負担が過大 |
| 代替案 | `raw_name`をそのまま保存し、`exercise_aliases`テーブルで既知の名前を筋肉群にマッピング |

**フォールバック戦略**:
```
raw_name → alias検索 → 見つかった場合: 筋肉マッピング適用
                     → 見つからない場合: unmappedとしてマーク（/recoveryで報告）
```

**シードデータの分離**:
- Aliasシードは`1970-01-01`の合成セッションを使用
- 全クエリで`session_date != 1970-01-01`をフィルタリングし、シードアーティファクトを除外
- これにより、シードデータが本番データと混在するリスクを排除

### 2. 回復アルゴリズム

**疲労計算**:
```
set_volume = reps × weight_kg
exercise_fatigue = Σ(set_volume) × muscle_weight（筋肉ごと）
```

**時間減衰（半減期）**:
| 筋肉群 | 半減期 |
|--------|--------|
| 脚 | 72時間 |
| その他 | 48時間 |

```python
decay_factor = 0.5 ** (経過時間 / 半減期)
現在の疲労 = 初期疲労 × decay_factor
回復率 = 100 - 現在の疲労
```

**ステータス閾値**:
| 回復率 | ステータス | 意味 |
|--------|-----------|------|
| ≥ 80% | 🟢 green | トレーニング可能 |
| 40–79% | 🟡 yellow | 軽いトレーニング可 |
| < 40% | 🔴 red | 休息推奨 |

### 3. 説明可能性（Explainability）

`/api/recovery`レスポンスには以下を含みます：
- **筋肉ごとの貢献エクササイズTop 2**（疲労貢献度順）
- **未マッピングエクササイズ**: aliasのない`raw_name`のリスト
- **`needs_review`フラグ**: パーサーの信頼度が低いセッション

これにより、ユーザー（および将来のAIアドバイスレイヤー）は*なぜ*その筋肉が疲労しているかを理解できます。

---

## 信頼性とテスト

| テストカテゴリ | カバレッジ |
|---------------|-----------|
| パーサーミスマッチ処理 | OCR形式が予期しない場合の安全な失敗 |
| シードセッション除外 | クエリが`1970-01-01`データを含まないことを保証 |
| 減衰妥当性 | `recovery(t=0) < recovery(t=48h)`（同一ワークアウト） |
| APIハードニング | 無効なUUID、欠落フィールド → 適切な4xxレスポンス |
| E2Eフロー | Upload → Worker → Parse → DB → API → UI |

```bash
pytest backend/tests/ -v
# 全テスト通過
```

---

## 実機検証

**iPhone Safari**でLAN経由で検証済み：
1. MacとiPhoneを同一Wi-Fiに接続
2. Vite開発サーバーを`--host 0.0.0.0`で起動
3. FastAPIを`0.0.0.0:8000`にバインド
4. ワークアウトスクリーンショットをアップロード → パース済みセッションを確認 → 回復状態を確認

これはエミュレータではなく、実際のデバイスでの検証です。

---

## 本プロジェクトが示すもの

| 観点 | 根拠 |
|------|------|
| **データモデリング** | フォールバックaliasマッピングを持つセッションスコープエクササイズ |
| **アルゴリズム設計** | 設定可能な半減期を持つ時間減衰疲労モデル |
| **説明可能性** | 筋肉ごとの貢献度内訳、未マッピング追跡 |
| **信頼性** | エッジケース処理、包括的なテストカバレッジ |
| **実環境検証** | iPhone Safari実機検証（localhostのみではない） |
| **拡張性** | OCRプラグイン化、AIアドバイスレイヤー対応可能 |

---

## まとめ

本プロジェクトは、機能の数よりも**データ品質、説明可能性、実環境での使用性**を優先したフィットネストラッキングMVPです。

回復アルゴリズムはブラックボックスではありません。すべての推奨は特定のワークアウトとセットに遡って追跡可能です。

---

*バックエンドアーキテクチャ、アルゴリズム設計、モバイルファースト開発を示すポートフォリオプロジェクトとして構築*
