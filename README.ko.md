# Health Recovery Tracker

> 운동 스크린샷에서 근육별 회복 상태를 추적하고, 설명 가능한 추천을 제공합니다.

**상태**: v1.0 (제조 완료)  
**플랫폼**: Web (Mobile Safari 실사용 검증)

---

## 이 프로젝트를 만든 이유

기존 운동 앱들은 "무엇을 했는지"는 잘 기록하지만, 정작 중요한 질문에는 답하지 못합니다:
- **"오늘 어떤 근육을 훈련해도 되는가?"**
- **"각 근육이 얼마나 회복되었는가?"**

여러 운동(웨이트, 유산소)을 근육 단위의 피로도로 통합하는 것은 쉽지 않습니다. 기존 도구들은 전신 피로도로 과도하게 단순화하거나, 번거로운 수동 입력을 요구합니다.

이 프로젝트는 **실제로 사용 가능한 솔루션**을 탐구합니다: 스크린샷 기반 입력 + 비동기 처리 파이프라인, 그리고 회복/피로도 분석을 위한 구조화된 데이터.

---

## 해결 방식

운동 스크린샷(예: Fleek 앱 내보내기)을 구조화된 데이터로 변환하고, 시간 감쇠 모델을 사용해 근육별 회복 상태를 계산합니다. 

핵심은 **설명 가능성**입니다. 각 근육에 대해 "왜 이 상태인지"를 Top 기여 운동과 함께 보여줍니다.

---

## 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         iPhone Safari                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FastAPI (0.0.0.0:8000)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐ │
│  │ /uploads │  │/sessions │  │/recovery │  │ /exercises/alias │ │
│  └────┬─────┘  └──────────┘  └────┬─────┘  └──────────────────┘ │
└───────┼───────────────────────────┼─────────────────────────────┘
        │                           │
        ▼                           │
┌───────────────┐                   │
│  Redis Queue  │                   │
└───────┬───────┘                   │
        │                           │
        ▼                           │
┌───────────────┐                   │
│   RQ Worker   │                   │
│  ┌─────────┐  │                   │
│  │ Parser  │  │                   │
│  └────┬────┘  │                   │
└───────┼───────┘                   │
        │                           │
        ▼                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                         PostgreSQL                               │
│  uploads │ sessions │ exercises │ sets │ exercise_aliases       │
└─────────────────────────────────────────────────────────────────┘
```

### 왜 이렇게 분리했는가?

| 구간 | 분리 이유 |
|------|----------|
| **Upload API → Queue** | 클라이언트에게 즉시 응답. 무거운 처리는 뒤에서 |
| **Worker 분리** | 파싱 실패가 API 가용성에 영향을 주지 않도록 격리 |
| **Parser 모듈화** | 현재는 Fleek OCR 포맷. 나중에 다른 소스도 플러그인처럼 추가 가능 |
| **Recovery 온디맨드 계산** | 캐시 무효화 걱정 없이 항상 최신 데이터 반영 |

---

## 기술 스택

| 레이어 | 기술 | 선택 이유 |
|--------|------|----------|
| API | FastAPI | 자동 문서화, 타입 힌트, async 지원 |
| ORM | SQLAlchemy 2.0 | 명시적 쿼리, 미래 확장성 |
| DB | PostgreSQL | 관계형 무결성, JSON 지원 |
| Queue | Redis + RQ | 로컬 개발에 최소한의 오버헤드 |
| Frontend | Vue 3 + TypeScript | 반응형, 모바일 친화적 |
| Infra | Docker Compose | 비용 0으로 로컬 우선 개발 |

---

## 핵심 설계 판단

### 1. Session-Scoped Exercise 모델

운동(exercise)을 글로벌 마스터 테이블에 저장하지 않고, **각 세션에 귀속**시켰습니다.

#### 왜 이런 결정을 했는가?

고민했던 선택지들:

| 옵션 | 장점 | 단점 |
|------|------|------|
| **글로벌 마스터** | 중복 제거, 정규화 | 표기 통일 작업 필요, MVP에서 과한 복잡도 |
| **세션별 저장 (선택)** | 유연함, 빠른 구현 | alias 매핑 필요 |

최종적으로 `raw_name`을 그대로 저장하고, `exercise_aliases` 테이블로 알려진 이름만 근육에 매핑하는 **폴백 전략**을 선택했습니다.

```
raw_name → alias 조회 → 있으면: 근육 매핑
                      → 없으면: unmapped로 표시 (/recovery에서 리포트)
```

#### Seed 데이터 처리

- Alias seed는 `1970-01-01` 날짜의 합성 세션을 사용
- 모든 쿼리에서 `session_date != 1970-01-01` 필터링
- 이렇게 하면 seed와 실제 데이터가 섞일 위험이 없음

### 2. Recovery 알고리즘

**피로도 계산**:
```
set_volume = reps × weight_kg
exercise_fatigue = Σ(set_volume) × muscle_weight (근육별)
```

**시간 감쇠 (Half-Life)**:
| 근육 그룹 | 반감기 |
|----------|--------|
| 하체 | 72시간 |
| 그 외 | 48시간 |

```python
decay_factor = 0.5 ** (경과시간 / 반감기)
현재_피로도 = 초기_피로도 × decay_factor
회복률 = 100 - 현재_피로도
```

**왜 이 반감기를 선택했는가?**
- 스포츠 과학 문헌에서 하체 근육(대퇴사두, 둔근)은 다른 부위보다 회복에 더 긴 시간이 필요하다고 알려져 있음
- 48h/72h는 보수적인 기본값이며, 향후 사용자별 커스터마이징 가능하게 설계

**상태 임계값**:
| 회복률 | 상태 | 의미 |
|--------|------|------|
| ≥ 80% | 🟢 green | 훈련 가능 |
| 40–79% | 🟡 yellow | 가벼운 훈련 OK |
| < 40% | 🔴 red | 휴식 권장 |

### 3. 설명 가능성 (Explainability)

`/api/recovery` 응답에 포함되는 정보:
- **근육별 Top 2 기여 운동** (피로도 기여 순)
- **Unmapped 운동 목록**: alias가 없는 `raw_name`들
- **`needs_review` 플래그**: 파서 신뢰도가 낮은 세션

**왜 이게 중요한가?**

단순히 "가슴 80% 회복"이라고 보여주면, 사용자는 왜 그런지 모릅니다. "어제 벤치프레스 5세트가 주요 원인"이라고 알려주면 신뢰할 수 있습니다.

---

## 신뢰성 & 테스트

| 테스트 카테고리 | 커버리지 |
|----------------|----------|
| 파서 mismatch 처리 | OCR 포맷이 예상과 다를 때 안전하게 실패 |
| Seed 세션 제외 | 쿼리에 `1970-01-01` 데이터가 절대 포함되지 않음 |
| 감쇠 정합성 | `recovery(t=0) < recovery(t=48h)` 동일 운동에서 |
| API 견고성 | 잘못된 UUID, 누락 필드 → 적절한 4xx 응답 |
| E2E 플로우 | Upload → Worker → Parse → DB → API → UI |

```bash
pytest backend/tests/ -v
# 전체 테스트 통과
```

---

## 실사용 검증

**iPhone Safari**에서 LAN으로 검증:
1. Mac과 iPhone을 같은 Wi-Fi에 연결
2. Vite 개발 서버를 `--host 0.0.0.0`으로 실행
3. FastAPI를 `0.0.0.0:8000`에 바인딩
4. 운동 스크린샷 업로드 → 파싱된 세션 확인 → 회복 상태 확인

**에뮬레이터가 아닌 실제 디바이스에서 검증**했다는 점이 중요합니다.

---

## 이 프로젝트가 보여주는 것

| 관점 | 근거 |
|------|------|
| **데이터 모델링** | 폴백 alias 매핑을 가진 세션 스코프 운동 |
| **알고리즘 설계** | 설정 가능한 반감기의 시간 감쇠 피로도 모델 |
| **설명 가능성** | 근육별 기여도 분석, unmapped 추적 |
| **신뢰성** | 엣지 케이스 처리, 포괄적 테스트 커버리지 |
| **실환경 검증** | localhost가 아닌 iPhone Safari 실기 검증 |
| **확장성** | OCR 플러그인화, AI 어드바이스 레이어 준비 |

---

## 한계 & 향후 계획

| 현재 | 계획 |
|------|------|
| OCR 텍스트 입력 (사전 추출) | Tesseract 또는 클라우드 OCR 통합 |
| 단일 사용자 | 인증 추가로 다중 사용자 |
| 수동 alias 관리 | AI 기반 alias 제안 |
| 회복만 | 피로도 예측 + 운동 추천 |

---

## 요약

이 프로젝트는 기능의 개수보다 **데이터 품질, 설명 가능성, 실환경 사용성**을 우선한 피트니스 트래킹 MVP입니다.

회복 알고리즘은 블랙박스가 아닙니다. 모든 추천은 특정 운동과 세트로 추적 가능합니다.

---

*백엔드 아키텍처, 알고리즘 설계, 모바일 퍼스트 개발을 보여주는 포트폴리오 프로젝트로 제작*
